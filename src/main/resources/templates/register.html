<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Registro | Planeta Consciente</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" th:href="@{/css/register.css}">
</head>
<body>
    <div class="register-container">
        <h1>Crear Cuenta</h1>
        
        <!-- Mensaje de error desde flash attributes -->
        <div th:if="${errorMessage}" class="message error" th:text="${errorMessage}">
        </div>
        
        <!-- Mensaje de √©xito desde par√°metros URL -->
        <div th:if="${param.success}" class="message success">
            ¬°Registro exitoso! Por favor inicia sesi√≥n.
        </div>
        
        <form th:action="@{/register}" th:object="${user}" method="post" id="registerForm">
            <!-- Campo Nombre -->
            <div class="form-group">
                <label for="nombre">Nombre Completo</label>
                <input type="text" id="nombre" name="nombre" th:field="*{nombre}" 
                       placeholder="Ingresa tu nombre completo" required>
                <div id="nombreError" class="error-message" th:if="${#fields.hasErrors('nombre')}">
                    <span th:errors="*{nombre}"></span>
                </div>
            </div>
            
            <!-- Campo Email -->
            <div class="form-group">
                <label for="email">Correo Electr√≥nico</label>
                <input type="email" id="email" name="email" th:field="*{email}" 
                       placeholder="Ingresa tu correo electr√≥nico" required>
                <div id="emailError" class="error-message" th:if="${#fields.hasErrors('email')}">
                    <span th:errors="*{email}"></span>
                </div>
            </div>
            
            <!-- Campo Contrase√±a -->
            <div class="form-group">
                <label for="password">Contrase√±a</label>
                <input type="password" id="password" name="password" th:field="*{password}" 
                       placeholder="Crea una contrase√±a segura" required minlength="8">
                <div class="password-requirements">
                    La contrase√±a debe tener al menos 8 caracteres
                </div>
                <div id="passwordError" class="error-message" th:if="${#fields.hasErrors('password')}">
                    <span th:errors="*{password}"></span>
                </div>
            </div>
            
            <!-- Confirmar Contrase√±a -->
            <div class="form-group">
                <label for="confirmPassword">Confirmar Contrase√±a</label>
                <input type="password" id="confirmPassword" name="confirmPassword" 
                       placeholder="Repite tu contrase√±a" required>
                <div id="confirmPasswordError" class="error-message">
                    Las contrase√±as no coinciden
                </div>
            </div>
            
            <button type="submit">Registrarse</button>
        </form>
        
        <a th:href="@{/login}" class="login-link">¬øYa tienes cuenta? Inicia sesi√≥n</a>
    </div>

    <!-- JavaScript en tiempo real - DENTRO del body -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üîî JavaScript de registro cargado');
        
        const form = document.getElementById('registerForm');
        const nombre = document.getElementById('nombre');
        const email = document.getElementById('email');
        const password = document.getElementById('password');
        const confirmPassword = document.getElementById('confirmPassword');
        
        // Ocultar mensajes de error de Thymeleaf inicialmente
        const thymeleafErrors = document.querySelectorAll('.error-message[th\\:if]');
        thymeleafErrors.forEach(error => {
            error.style.display = 'none';
        });
        
        // Crear elementos de error din√°micos si no existen
        let nombreError = document.getElementById('nombreError');
        let emailError = document.getElementById('emailError'); 
        let passwordError = document.getElementById('passwordError');
        let confirmPasswordError = document.getElementById('confirmPasswordError');
        
        if (!nombreError) nombreError = crearElementoError('nombre');
        if (!emailError) emailError = crearElementoError('email');
        if (!confirmPasswordError) confirmPasswordError = crearElementoError('confirmPassword');
        
        function crearElementoError(fieldId) {
            const field = document.getElementById(fieldId);
            if (!field) return null;
            
            const errorDiv = document.createElement('div');
            errorDiv.id = fieldId + 'Error';
            errorDiv.className = 'error-message';
            field.parentNode.appendChild(errorDiv);
            return errorDiv;
        }
        
        // Validaci√≥n en tiempo real - AMBOS CAMPOS
        if (nombre) nombre.addEventListener('input', validarNombre);
        if (email) email.addEventListener('input', validarEmail);
        if (password) {
            password.addEventListener('input', function() {
                validarPassword(); // Validar longitud
                validarConfirmPassword(); // Validar coincidencia (IMPORTANTE)
            });
        }
        if (confirmPassword) {
            confirmPassword.addEventListener('input', function() {
                validarConfirmPassword(); // Validar coincidencia
            });
        }
        
        // Tambi√©n validar al perder foco
        if (nombre) nombre.addEventListener('blur', validarNombre);
        if (email) email.addEventListener('blur', validarEmail);
        if (password) {
            password.addEventListener('blur', function() {
                validarPassword();
                validarConfirmPassword();
            });
        }
        if (confirmPassword) confirmPassword.addEventListener('blur', validarConfirmPassword);
        
        function validarNombre() {
            if (!nombreError) return;
            
            if (nombre.value.trim() === '') {
                nombre.classList.add('error-field');
                nombreError.textContent = 'El nombre es obligatorio';
                nombreError.style.display = 'block';
            } else {
                nombre.classList.remove('error-field');
                nombreError.style.display = 'none';
            }
        }
        
        function validarEmail() {
            if (!emailError) return;
            
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            
            if (email.value.trim() === '') {
                email.classList.add('error-field');
                emailError.textContent = 'El email es obligatorio';
                emailError.style.display = 'block';
            } else if (!emailRegex.test(email.value)) {
                email.classList.add('error-field');
                emailError.textContent = 'Formato de email inv√°lido';
                emailError.style.display = 'block';
            } else {
                email.classList.remove('error-field');
                emailError.style.display = 'none';
            }
        }
        
        function validarPassword() {
            if (!passwordError) return;
            
            // Ocultar mensaje de Thymeleaf para contrase√±a
            const thymeleafPasswordError = document.querySelector('#passwordError[th\\:if]');
            if (thymeleafPasswordError) {
                thymeleafPasswordError.style.display = 'none';
            }
            
            if (password.value.length < 8) {
                password.classList.add('error-field');
                passwordError.textContent = 'La contrase√±a debe tener al menos 8 caracteres';
                passwordError.style.display = 'block';
                return false;
            } else {
                password.classList.remove('error-field');
                passwordError.style.display = 'none';
                return true;
            }
        }
        
        function validarConfirmPassword() {
            if (!confirmPasswordError) return;
            
            // Solo validar si ambos campos tienen contenido
            if (password.value && confirmPassword.value) {
                if (password.value !== confirmPassword.value) {
                    confirmPassword.classList.add('error-field');
                    confirmPasswordError.textContent = 'Las contrase√±as no coinciden';
                    confirmPasswordError.style.display = 'block';
                } else {
                    confirmPassword.classList.remove('error-field');
                    confirmPasswordError.textContent = '‚úì Las contrase√±as coinciden';
                    confirmPasswordError.style.display = 'block';
                    confirmPasswordError.style.color = '#2e7d32'; // Verde
                }
            } else {
                // Si alg√∫n campo est√° vac√≠o, ocultar el mensaje
                confirmPassword.classList.remove('error-field');
                confirmPasswordError.style.display = 'none';
            }
        }
        
        // Validaci√≥n al enviar
        if (form) {
            form.addEventListener('submit', function(e) {
                validarNombre();
                validarEmail();
                validarPassword();
                validarConfirmPassword();
                
                const errores = document.querySelectorAll('.error-field');
                if (errores.length > 0) {
                    e.preventDefault();
                    errores[0].scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            });
        }
        
        // Limpiar errores al escribir (pero mantener validaci√≥n de coincidencia)
        const inputs = form.querySelectorAll('input');
        inputs.forEach(input => {
            input.addEventListener('input', function() {
                // No limpiar errores de confirmaci√≥n autom√°ticamente
                if (this.id !== 'confirmPassword') {
                    this.classList.remove('error-field');
                    const errorElement = document.getElementById(this.id + 'Error');
                    if (errorElement && this.id !== 'confirmPassword') {
                        errorElement.style.display = 'none';
                    }
                }
            });
        });
    });
    </script>
</body>
</html>