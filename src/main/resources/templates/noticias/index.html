<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" 
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/base}">
<head>
    <title>Noticias Ambientales - Planeta Consciente</title>
    
    <!-- Estilos específicos de la página -->
    <link th:href="@{/css/noticia.css}" rel="stylesheet">
</head>

<body>
    <div layout:fragment="content" class="container noticias-container">
        <div class="noticias-header">
            <h1>NOTICIAS AMBIENTALES</h1>
            <p>Mantente informado sobre las últimas novedades en sostenibilidad y cuidado del medio ambiente</p>
        </div>

        <!-- Formulario de Filtrado -->
        <div class="filtro-noticias">
            <form th:action="@{/noticias}" method="GET" class="filtro-form" id="filtroForm">
                <!-- Búsqueda -->
                <div class="filtro-group">
                    <label for="busqueda">Buscar noticias</label>
                    <input type="text" name="busqueda" id="busqueda" 
                           placeholder="Ej: cambio climático" 
                           th:value="${param.busqueda != null} ? ${param.busqueda} : ''">
                </div>
                
                <!-- Fuente -->
                <div class="filtro-group">
                    <label for="fuente">Fuente</label>
                    <select name="fuente" id="fuente">
                        <option value="">Todas las fuentes</option>
                        <option th:each="fuente : ${fuentes}" 
                                th:value="${fuente}"
                                th:text="${fuente}"
                                th:selected="${param.fuente != null && param.fuente == fuente}">
                        </option>
                    </select>
                </div>
                
                <!-- Fecha Desde -->
                <div class="filtro-group">
                    <label for="fecha_desde">Fecha desde</label>
                    <input type="date" name="fecha_desde" id="fecha_desde" 
                           th:value="${param.fecha_desde}">
                </div>
                
                <!-- Fecha Hasta -->
                <div class="filtro-group">
                    <label for="fecha_hasta">Fecha hasta</label>
                    <input type="date" name="fecha_hasta" id="fecha_hasta" 
                           th:value="${param.fecha_hasta}">
                </div>
                
                <!-- Botones -->
                <div class="filtro-actions">
                    <button type="submit" class="btn-filtrar">
                        <i class="fas fa-search"></i> Buscar
                    </button>
                    
                    <th:block th:if="${param.busqueda != null or 
                                    param.fuente != null or 
                                    param.fecha_desde != null or 
                                    param.fecha_hasta != null}">
                        <a th:href="@{/noticias}" class="btn-limpiar">
                            Limpiar
                        </a>
                    </th:block>

                    <!-- Botón para generar PDF (solo si hay filtros aplicados) -->
                    <th:block th:if="${param.busqueda != null or 
                                    param.fuente != null or 
                                    param.fecha_desde != null or 
                                    param.fecha_hasta != null}">
                        <button type="submit" name="generar_pdf" value="1" class="btn-filtrar">
                            <i class="fas fa-file-pdf"></i> Generar PDF
                        </button>
                    </th:block>
                </div>
            </form>
        </div>

        <div class="update-info">
            Última actualización: <span id="update-time"></span>
        </div>
        
        <th:block th:if="${noticias.empty}">
            <div class="no-resultados">
                <i class="fas fa-info-circle"></i> No se encontraron noticias con los criterios seleccionados
            </div>
        </th:block>
        
        <th:block th:unless="${noticias.empty}">
            <div sec:authorize="isAuthenticated()" th:if="${#authorization.expression('hasRole(''ROLE_ADMIN'')')}" class="admin-actions">
                <a th:href="@{/noticias/nueva}" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Crear Nueva Noticia
                </a>
            </div>

            <div class="grid-noticias">
                <th:block th:each="noticia : ${noticias}">
                <div class="noticia-card">
                    <div class="noticia-imagen-container">
                        <th:block th:if="${noticia.imagenUrl}">
                            <img th:src="@{${noticia.imagenUrl}}" th:alt="${noticia.titulo}" class="noticia-imagen" loading="lazy">
                        </th:block>
                        <th:block th:unless="${noticia.imagenUrl}">
                            <img src="https://source.unsplash.com/random/600x400/?nature,eco" alt="Imagen de noticia" class="noticia-imagen" loading="lazy">
                        </th:block>
                    </div>
                    
                    <div class="noticia-content">
                        <div class="noticia-meta">
                            <span class="noticia-date"><i class="far fa-calendar-alt"></i> 
                                <span th:text="${#temporals.format(noticia.fechaPublicacion, 'dd MMM, yyyy')}"></span>
                            </span>
                            <th:block th:if="${noticia.fuente}">
                                <span class="noticia-source" th:text="${noticia.fuente}"></span>
                            </th:block>
                        </div>
                        
                        <h3 class="noticia-title" th:text="${noticia.titulo}"></h3>
                        <p class="noticia-excerpt" th:text="${noticia.resumen}"></p>
                        
                        <a th:href="@{/noticias/{id}(id=${noticia.id})}" class="noticia-link">
                            Leer más <i class="fas fa-arrow-right"></i>
                        </a>
                    </div>
                </div>
                </th:block>
            </div>

            <div class="pagination-container">
                <!-- Asumiendo que estás usando Spring Data JPA con paginación -->
                <div th:if="${noticias.totalPages > 1}">
                    <ul class="pagination">
                        <li th:class="${noticias.first} ? 'page-item disabled' : 'page-item'">
                            <a th:href="@{/noticias(page=0, size=${noticias.size}, busqueda=${param.busqueda}, fuente=${param.fuente}, fecha_desde=${param.fecha_desde}, fecha_hasta=${param.fecha_hasta})}" 
                               class="page-link">« Primera</a>
                        </li>
                        <li th:class="${noticias.hasPrevious()} ? 'page-item' : 'page-item disabled'">
                            <a th:href="@{/noticias(page=${noticias.number-1}, size=${noticias.size}, busqueda=${param.busqueda}, fuente=${param.fuente}, fecha_desde=${param.fecha_desde}, fecha_hasta=${param.fecha_hasta})}" 
                               class="page-link">‹ Anterior</a>
                        </li>
                        <li th:each="i : ${#numbers.sequence(1, noticias.totalPages)}" 
                            th:class="${noticias.number+1 == i} ? 'page-item active' : 'page-item'">
                            <a th:href="@{/noticias(page=${i-1}, size=${noticias.size}, busqueda=${param.busqueda}, fuente=${param.fuente}, fecha_desde=${param.fecha_desde}, fecha_hasta=${param.fecha_hasta})}" 
                               class="page-link" th:text="${i}"></a>
                        </li>
                        <li th:class="${noticias.hasNext()} ? 'page-item' : 'page-item disabled'">
                            <a th:href="@{/noticias(page=${noticias.number+1}, size=${noticias.size}, busqueda=${param.busqueda}, fuente=${param.fuente}, fecha_desde=${param.fecha_desde}, fecha_hasta=${param.fecha_hasta})}" 
                               class="page-link">Siguiente ›</a>
                        </li>
                        <li th:class="${noticias.last} ? 'page-item disabled' : 'page-item'">
                            <a th:href="@{/noticias(page=${noticias.totalPages-1}, size=${noticias.size}, busqueda=${param.busqueda}, fuente=${param.fuente}, fecha_desde=${param.fecha_desde}, fecha_hasta=${param.fecha_hasta})}" 
                               class="page-link">Última »</a>
                        </li>
                    </ul>
                </div>
            </div>
        </th:block>
    </div>

    <!-- Incluye SweetAlert2 directamente -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
    // Función para mostrar errores del servidor
    function showServerErrors() {
        // Esto necesitaría ser manejado desde el controlador en Spring
        // Puedes pasar los errores como atributo del modelo
        /*[[${#fields.hasErrors()}]]*/ 
        const hasErrors = /*[[${#fields.hasErrors()}]]*/ false;
        
        if(hasErrors) {
            const errors = /*[[${#fields.errors()}]]*/ [];
            
            let errorList = '<div style="text-align:left; margin-left:20px;"><ul>';
            errors.forEach(error => {
                errorList += `<li>${error}</li>`;
            });
            errorList += '</ul></div>';
            
            Swal.fire({
                icon: 'error',
                title: 'Error en los filtros',
                html: errorList,
                confirmButtonColor: '#4caf7d'
            });
        }
    }

    // Validación en tiempo real
    document.getElementById('filtroForm').addEventListener('submit', function(e) {
        const fechaDesde = document.getElementById('fecha_desde').value;
        const fechaHasta = document.getElementById('fecha_hasta').value;
        
        if(fechaDesde && fechaHasta && new Date(fechaHasta) < new Date(fechaDesde)) {
            e.preventDefault();
            
            // Marcar campos en rojo
            document.getElementById('fecha_desde').style.borderColor = '#e74c3c';
            document.getElementById('fecha_hasta').style.borderColor = '#e74c3c';
            
            Swal.fire({
                icon: 'error',
                title: 'Error en fechas',
                text: 'La fecha final no puede ser anterior a la fecha inicial',
                confirmButtonColor: '#4caf7d'
            });
        }
    });

    // Mostrar errores al cargar la página
    document.addEventListener('DOMContentLoaded', function() {
        showServerErrors();
        
        // Tu código original de actualización de hora
        function updateDateTime() {
            const now = new Date();
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            };
            document.getElementById('update-time').textContent = now.toLocaleDateString('es-ES', options);
        }
        updateDateTime();
        setInterval(updateDateTime, 60000);
    });

    // Estilos para campos inválidos
    const style = document.createElement('style');
    style.textContent = `
        .filtro-group input:invalid, 
        .filtro-group select:invalid {
            border-color: #e74c3c !important;
            background-color: #fef0ef !important;
        }
        .filtro-group input:focus:invalid,
        .filtro-group select:focus:invalid {
            box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.2) !important;
        }
    `;
    document.head.appendChild(style);
    </script>
</body>
</html>