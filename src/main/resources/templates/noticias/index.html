<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" 
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{layout/base}">
<head>
    <title>Noticias Ambientales - Planeta Consciente</title>
    <link th:href="@{/css/noticia.css}" rel="stylesheet">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
</head>

<body>
<div layout:fragment="content" class="container noticias-container">
    <div class="noticias-header">
        <h1>NOTICIAS AMBIENTALES</h1>
        <p>Mantente informado sobre las últimas novedades en sostenibilidad y cuidado del medio ambiente</p>
    </div>

    <!-- ✅ NUEVO: Mensaje de error de validación de fechas -->
    <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>

    <!-- Formulario de Filtrado -->
    <div class="filtro-noticias">
        <form th:action="@{/noticias}" 
            th:object="${filtro}"
            method="GET" 
            class="filtro-form" 
            id="filtroForm">

            <!-- Búsqueda -->
            <div class="filtro-group">
                <label for="busqueda">Buscar noticias</label>
                <input type="text" th:field="*{busqueda}" placeholder="Ej: cambio climático">
            </div>

            <!-- Fuente -->
            <div class="filtro-group">
                <label for="fuente">Fuente</label>
                <select th:field="*{fuente}">
                    <option value="">Todas las fuentes</option>
                    <option th:each="f : ${fuentes}"
                            th:value="${f}"
                            th:text="${f}">
                    </option>
                </select>
            </div>

            <!-- Fecha Desde -->
            <div class="filtro-group">
                <label for="fecha_desde">Fecha desde</label>
                <input type="date"
                    name="fecha_desde"
                    id="fecha_desde"
                    th:value="${filtro.fechaDesde != null ? #temporals.format(filtro.fechaDesde, 'yyyy-MM-dd') : ''}">
            </div>

            <!-- Fecha Hasta -->
            <div class="filtro-group">
                <label for="fecha_hasta">Fecha hasta</label>
                <input type="date"
                    name="fecha_hasta"
                    id="fecha_hasta"
                    th:value="${filtro.fechaHasta != null ? #temporals.format(filtro.fechaHasta, 'yyyy-MM-dd') : ''}">
            </div>

            <!-- Botones -->
            <div class="filtro-actions">

                <button type="submit" class="btn-filtrar">
                    <i class="fas fa-search"></i> Buscar
                </button>

                <!-- Mostrar 'Limpiar' solo si hubo filtros -->
                <th:block th:if="${! #strings.isEmpty(filtro.busqueda ?: '') or 
                                    ! #strings.isEmpty(filtro.fuente ?: '') or 
                                    filtro.fechaDesde != null or 
                                    filtro.fechaHasta != null}">

                    <a th:href="@{/noticias}" class="btn-limpiar">Limpiar</a>
                </th:block>

                <!-- Exportar SOLO si hay filtros -->
                <th:block th:if="${! #strings.isEmpty(filtro.busqueda ?: '') or 
                                    ! #strings.isEmpty(filtro.fuente ?: '') or 
                                    filtro.fechaDesde != null or 
                                    filtro.fechaHasta != null}">

                    <!-- PDF -->
                    <a class="btn-filtrar export-btn"
                    data-loading="Generando PDF..."
                    th:href="@{/exportar/noticias/pdf(
                            busqueda=${filtro.busqueda},
                            fuente=${filtro.fuente},
                            fecha_desde=${filtro.fechaDesde},
                            fecha_hasta=${filtro.fechaHasta}
                    )}">
                        <i class="fas fa-file-pdf"></i> Generar PDF
                    </a>

                    <!-- Excel -->
                    <a class="btn-filtrar export-btn"
                    data-loading="Generando Excel..."
                    th:href="@{/exportar/noticias/excel(
                            busqueda=${filtro.busqueda},
                            fuente=${filtro.fuente},
                            fecha_desde=${filtro.fechaDesde},
                            fecha_hasta=${filtro.fechaHasta}
                    )}">
                        <i class="fas fa-file-excel"></i> Exportar Excel
                    </a>

                    <!-- CSV -->
                    <a class="btn-filtrar export-btn"
                    data-loading="Generando CSV..."
                    th:href="@{/exportar/noticias/csv(
                            busqueda=${filtro.busqueda},
                            fuente=${filtro.fuente},
                            fecha_desde=${filtro.fechaDesde},
                            fecha_hasta=${filtro.fechaHasta}
                    )}">
                        <i class="fas fa-file-csv"></i> Exportar CSV
                    </a>
                </th:block>
            </div>
        </form>
    </div>

    <div class="update-info">
        Última actualización: <span id="update-time"></span>
    </div>

    <th:block th:if="${noticias.empty}">
        <div class="no-resultados">
            <i class="fas fa-info-circle"></i> No se encontraron noticias con los criterios seleccionados
        </div>
    </th:block>

    <th:block th:unless="${noticias.empty}">
        <!-- ✅ Mostrar solo a administradores -->
        <div sec:authorize="hasRole('ADMIN')" class="admin-actions">
            <a th:href="@{/noticias/nueva}" class="btn btn-primary">
                <i class="fas fa-plus"></i> Crear Nueva Noticia
            </a>
        </div>

        <div class="results-counter mb-3">
            <strong th:text="${noticias.totalElements}"></strong> resultados encontrados
            <span th:if="${noticias.totalPages > 0}">
                — Página <strong th:text="${noticias.number + 1}"></strong> de 
                <strong th:text="${noticias.totalPages}"></strong>
            </span>
        </div>

        <!-- Skeletons -->
        <div id="skeleton-container" class="skeleton-wrapper">
            <div class="skeleton-card"></div>
            <div class="skeleton-card"></div>
            <div class="skeleton-card"></div>
        </div>

        <!-- Noticias -->
        <div class="grid-noticias" style="opacity: 0;">
            <th:block th:each="noticia : ${noticias}">
                <div class="noticia-card">
                    <div class="noticia-imagen-container">
                        <th:block th:if="${noticia.imagenUrl}">
                            <img th:src="@{${noticia.imagenUrl} + '?v=' + ${#dates.createNow().time}}" 
                                 th:alt="${noticia.titulo}" 
                                 class="noticia-imagen lazy-img" 
                                 loading="lazy"
                                 onload="this.classList.add('loaded')"
                                 onerror="this.src='https://source.unsplash.com/random/600x400/?nature,eco'">
                        </th:block>
                        <th:block th:unless="${noticia.imagenUrl}">
                            <img src="https://source.unsplash.com/random/600x400/?nature,eco" 
                                 alt="Imagen de noticia" 
                                 class="noticia-imagen lazy-img" 
                                 loading="lazy"
                                 onload="this.classList.add('loaded')">
                        </th:block>
                    </div>

                    <div class="noticia-content">
                        <div class="noticia-meta">
                            <span class="noticia-date"><i class="far fa-calendar-alt"></i> 
                                <span th:text="${noticia.fechaPublicacion != null ? #temporals.format(noticia.fechaPublicacion, 'dd MMM, yyyy') : 'Sin fecha'}"></span>
                            </span>
                            <th:block th:if="${noticia.fuente}">
                                <span class="noticia-source" th:text="${noticia.fuente}"></span>
                            </th:block>
                        </div>

                        <h3 class="noticia-title" th:text="${noticia.titulo}"></h3>
                        <p class="noticia-excerpt" th:text="${noticia.resumen}"></p>

                        <a th:href="@{/noticias/{id}(id=${noticia.id})}" class="noticia-link">
                            Leer más <i class="fas fa-arrow-right"></i>
                        </a>

                        <!-- Botones solo para administradores -->
                        <div sec:authorize="hasRole('ADMIN')" class="noticia-admin-actions">
                            <a th:href="@{/noticias/{id}/editar(id=${noticia.id})}" 
                            class="btn btn-sm btn-warning">Editar</a>
                            
                            <form th:action="@{/noticias/{id}/eliminar(id=${noticia.id})}" 
                                method="POST" 
                                style="display:inline;"
                                class="form-eliminar">
                                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                                <button type="submit" 
                                        class="btn btn-sm btn-danger"
                                        th:attr="data-id=${noticia.id}, data-titulo=${noticia.titulo}">
                                    Eliminar
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </th:block>
        </div>

        <!-- Paginación -->
        <nav th:if="${noticias.totalPages > 1}">
            <ul class="pagination justify-content-center">

                <!-- Botón Anterior -->
                <li class="page-item" th:classappend="${noticias.first} ? 'disabled'">
                    <a class="page-link"
                    th:href="@{/noticias(
                        page=${noticias.number - 1},
                        size=${noticias.size},
                        busqueda=${filtro.busqueda},
                        fuente=${filtro.fuente},
                        fecha_desde=${filtro.fechaDesde},
                        fecha_hasta=${filtro.fechaHasta}
                    )}">
                    &laquo; Anterior
                    </a>
                </li>

                <!-- Número de página -->
                <li class="page-item"
                    th:each="i : ${#numbers.sequence(0, noticias.totalPages - 1)}"
                    th:classappend="${i == noticias.number} ? 'active'">

                    <a class="page-link"
                    th:text="${i + 1}"
                    th:href="@{/noticias(
                            page=${i},
                            size=${noticias.size},
                            busqueda=${filtro.busqueda},
                            fuente=${filtro.fuente},
                            fecha_desde=${filtro.fechaDesde},
                            fecha_hasta=${filtro.fechaHasta}
                        )}"></a>
                </li>

                <!-- Botón Siguiente -->
                <li class="page-item" th:classappend="${noticias.last} ? 'disabled'">
                    <a class="page-link"
                    th:href="@{/noticias(
                            page=${noticias.number + 1},
                            size=${noticias.size},
                            busqueda=${filtro.busqueda},
                            fuente=${filtro.fuente},
                            fecha_desde=${filtro.fechaDesde},
                            fecha_hasta=${filtro.fechaHasta}
                    )}">
                    Siguiente &raquo;
                    </a>
                </li>

            </ul>
        </nav>
    </th:block>

    <!-- Mensaje de error de filtro con SweetAlert2 -->
    <div th:if="${errorFiltro}" id="errorFiltroMsg" th:data-msg="${errorFiltro}" style="display:none;"></div>
    
    <!-- ✅ NUEVO: Mensaje de error de validación para SweetAlert2 -->
    <div th:if="${error}" id="errorMsg" th:data-msg="${error}" style="display:none;"></div>
</div>

<th:block layout:fragment="scripts">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        // ========== CONSTANTES Y VARIABLES ==========
        const CONFIG = {
            LOADING_TIMEOUT: 3000,
            BORDER_ERROR_COLOR: 'red'
        };

        // ========== FUNCIONES DE VALIDACIÓN ==========
        class ValidadorFechas {
            constructor() {
                this.fechaDesdeInput = document.getElementById('fecha_desde');
                this.fechaHastaInput = document.getElementById('fecha_hasta');
            }

            obtenerFechas() {
                return {
                    desde: this.fechaDesdeInput.value ? new Date(this.fechaDesdeInput.value) : null,
                    hasta: this.fechaHastaInput.value ? new Date(this.fechaHastaInput.value) : null
                };
            }

            resetearEstilos() {
                this.fechaDesdeInput.style.borderColor = '';
                this.fechaHastaInput.style.borderColor = '';
            }

            resaltarError() {
                this.fechaDesdeInput.style.borderColor = CONFIG.BORDER_ERROR_COLOR;
                this.fechaHastaInput.style.borderColor = CONFIG.BORDER_ERROR_COLOR;
            }

            validar() {
                const { desde, hasta } = this.obtenerFechas();
                this.resetearEstilos();

                if (desde && hasta && desde > hasta) {
                    this.resaltarError();
                    this.mostrarErrorUI();
                    return false;
                }
                return true;
            }

            validarSoloVisual() {
                const { desde, hasta } = this.obtenerFechas();
                this.resetearEstilos();

                if (desde && hasta && desde > hasta) {
                    this.resaltarError();
                }
            }

            mostrarErrorUI() {
                Swal.fire({
                    icon: 'warning',
                    title: 'Rango de fechas inválido',
                    text: 'La fecha "Desde" no puede ser posterior a la fecha "Hasta". Por favor corrige las fechas.',
                    confirmButtonText: 'Entendido'
                });
            }
        }

        // ========== FUNCIONES DE UI ==========
        class ManejadorUI {
            static manejarExportButtons() {
                // ✅ Selecciona ambos tipos de botones
                document.querySelectorAll(".btn-filtrar[data-loading], .export-btn").forEach(btn => {
                    btn.addEventListener("click", function(e) {
                        // Solo para botones de exportación (que tienen href)
                        if (this.getAttribute("href")) {
                            const text = this.innerHTML;
                            const loadingText = this.dataset.loading;

                            this.classList.add("loading");
                            this.innerHTML = loadingText;

                            setTimeout(() => {
                                this.classList.remove("loading");
                                this.innerHTML = text;
                            }, CONFIG.LOADING_TIMEOUT);
                        }
                    });
                });
            }

            static manejarSkeleton() {
                const skeleton = document.getElementById("skeleton-container");
                const contenido = document.querySelector(".grid-noticias");
                
                if (!skeleton || !contenido) return;
                
                // Ocultar skeleton y mostrar contenido inmediatamente
                // (ya que Thymeleaf carga el contenido del servidor)
                skeleton.style.display = "none";
                contenido.style.opacity = "1";
                contenido.classList.add("visible");
            }
        }

        // ========== CONFIRMACIÓN DE ELIMINACIÓN ==========
        class ConfirmacionEliminar {
            static init() {
                // Usar event delegation para manejar clics en botones de eliminar
                document.addEventListener('click', (e) => {
                    const btnEliminar = e.target.closest('.btn-danger[data-id]');
                    
                    if (btnEliminar) {
                        e.preventDefault(); // Prevenir envío inmediato
                        
                        const id = btnEliminar.dataset.id;
                        const titulo = btnEliminar.dataset.titulo;
                        const formulario = btnEliminar.closest('form.form-eliminar');
                        
                        this.mostrarConfirmacion(id, titulo, formulario, btnEliminar);
                    }
                });
            }
            
            static mostrarConfirmacion(id, titulo, formulario, btnEliminar) {
                // ✅ Usar getAttribute como fallback si dataset no funciona
                const tituloReal = btnEliminar.getAttribute('data-titulo') || titulo || 'Noticia sin título';
                const tituloEscapeado = this.escapeHtml(tituloReal);
                
                Swal.fire({
                    title: '¿Estás seguro?',
                    html: `
                        <div style="text-align: left;">
                            <p>Vas a eliminar la noticia:</p>
                            <p><strong>"${tituloEscapeado}"</strong></p>
                            <p class="text-danger" style="margin-top: 10px;">
                                <i class="fas fa-exclamation-triangle"></i>
                                Esta acción no se puede deshacer
                            </p>
                        </div>
                    `,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: 'Sí, eliminar',
                    cancelButtonText: 'Cancelar',
                    reverseButtons: true,
                    backdrop: true,
                    allowOutsideClick: false,
                    allowEscapeKey: true,
                    focusCancel: true,
                    customClass: {
                        popup: 'swal-eliminar-popup',
                        confirmButton: 'swal-eliminar-btn',
                        cancelButton: 'swal-cancelar-btn'
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        this.eliminarNoticia(formulario, btnEliminar);
                    }
                });
            }

            static escapeHtml(text) {
                // Si text es undefined o null, devolver cadena vacía
                if (!text) return '';
                
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
            
            static animarEliminacion(btnEliminar) {
                const tarjeta = btnEliminar.closest('.noticia-card');
                
                if (tarjeta) {
                    // Añadir clase de animación CSS
                    tarjeta.classList.add('eliminando');
                }
            }

            static eliminarNoticia(formulario, btnEliminar) {
                // Animación usando CSS
                this.animarEliminacion(btnEliminar);
                
                // Mostrar loader después de un breve delay para ver la animación
                setTimeout(() => {
                    Swal.fire({
                        title: 'Eliminando...',
                        text: 'Por favor espera',
                        allowOutsideClick: false,
                        allowEscapeKey: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });
                    
                    // Enviar formulario después de que la animación termine
                    setTimeout(() => {
                        formulario.submit();
                    }, 500);
                }, 300); // Pequeño delay para ver la animación
            }
        }

        // ========== FUNCIONES DE MENSAJES ==========
        class ManejadorMensajes {
            static mostrarErrorBackend() {
                // Mensaje de error de filtro
                const errorFiltroMsg = document.getElementById('errorFiltroMsg');
                if (errorFiltroMsg?.dataset?.msg) {
                    this.mostrarSweetAlert('error', 'Error en filtros', errorFiltroMsg.dataset.msg);
                    this.resaltarCamposFecha();
                }

                // Mensaje de error de validación
                const errorMsg = document.getElementById('errorMsg');
                if (errorMsg?.dataset?.msg) {
                    this.resaltarCamposFecha();
                    this.mostrarSweetAlert('error', 'Error en fechas', errorMsg.dataset.msg);
                }
            }

            static resaltarCamposFecha() {
                const fechaDesdeInput = document.getElementById('fecha_desde');
                const fechaHastaInput = document.getElementById('fecha_hasta');
                
                if (fechaDesdeInput && fechaHastaInput) {
                    fechaDesdeInput.style.borderColor = CONFIG.BORDER_ERROR_COLOR;
                    fechaHastaInput.style.borderColor = CONFIG.BORDER_ERROR_COLOR;
                }
            }

            static mostrarSweetAlert(icon, title, text) {
                Swal.fire({
                    icon: icon,
                    title: title,
                    text: text,
                    confirmButtonText: 'Cerrar'
                });
            }
        }

        // ========== INICIALIZACIÓN ==========
        document.addEventListener('DOMContentLoaded', function() {
            // 1. Inicializar validador
            const validador = new ValidadorFechas();

            // 2. Configurar formulario
            const formulario = document.getElementById('filtroForm');
            if (formulario) {
                formulario.addEventListener('submit', (event) => {
                    // Validar fechas antes de enviar
                    if (!validador.validar()) {
                        event.preventDefault();
                    }
                });
            }

            // 3. Configurar eventos de cambio en fechas
            if (validador.fechaDesdeInput) {
                validador.fechaDesdeInput.addEventListener('change', () => {
                    validador.validarSoloVisual();
                });
            }

            if (validador.fechaHastaInput) {
                validador.fechaHastaInput.addEventListener('change', () => {
                    validador.validarSoloVisual();
                });
            }

            // 4. Manejar mensajes del backend
            ManejadorMensajes.mostrarErrorBackend();

            // 5. Configurar UI
            ManejadorUI.manejarExportButtons();
            ManejadorUI.manejarSkeleton();
            
            // 6. Actualizar hora de última actualización
            const updateTimeElement = document.getElementById('update-time');
            if (updateTimeElement) {
                updateTimeElement.textContent = new Date().toLocaleString();
            }

            // 7. ✅ Inicializar sistema de confirmación de eliminación
            ConfirmacionEliminar.init();
        });
    </script>
</th:block>
</body>
</html>