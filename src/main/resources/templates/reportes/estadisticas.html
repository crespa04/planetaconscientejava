<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Estad√≠sticas de Huella de Carbono</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .card {
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .card-header {
            font-weight: bold;
        }
        .badge {
            font-size: 0.8em;
            padding: 0.5em 0.8em;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="text-primary">üìä Reporte de Estad√≠sticas - Huella de Carbono</h1>
            <div>
                <a th:href="@{/exportar/estadisticas/pdf}" class="btn btn-danger" th:if="${totalRegistros > 0}">
                    üìÑ Exportar a PDF
                </a>
                <a th:href="@{/}" class="btn btn-outline-secondary">üè† Inicio</a>
            </div>
        </div>

        <!-- Mensaje de error -->
        <div th:if="${error}" class="alert alert-danger" role="alert">
            <h5>‚ùå Error</h5>
            <span th:text="${error}"></span>
        </div>

        <!-- Mensaje cuando no hay datos -->
        <div th:if="${totalRegistros == 0}" class="alert alert-info text-center">
            <h4>üìä No hay datos disponibles</h4>
            <p class="mb-3">No se han registrado c√°lculos de huella de carbono a√∫n.</p>
            <a th:href="@{/calculadora}" class="btn btn-primary btn-lg">Realizar Primer C√°lculo</a>
        </div>

        <!-- Contenido cuando hay datos -->
        <div th:if="${totalRegistros > 0}">
            <!-- Filtros por fecha para exportaci√≥n -->
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">üìÖ Exportar con Filtros de Fecha</h5>
                </div>
                <div class="card-body">
                    <form th:action="@{/exportar/estadisticas/pdf}" method="get" class="row g-3 align-items-end">
                        <div class="col-md-4">
                            <label for="fecha_desde" class="form-label">Desde:</label>
                            <input type="date" id="fecha_desde" name="fecha_desde" class="form-control">
                        </div>
                        <div class="col-md-4">
                            <label for="fecha_hasta" class="form-label">Hasta:</label>
                            <input type="date" id="fecha_hasta" name="fecha_hasta" class="form-control">
                        </div>
                        <div class="col-md-4">
                            <button type="submit" class="btn btn-primary w-100">üìä Exportar con Filtros</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Tarjetas de resumen -->
            <div class="row mb-4">
                <div class="col-md-4">
                    <div class="card text-white bg-primary">
                        <div class="card-body text-center">
                            <h5 class="card-title">Total de Registros</h5>
                            <h2 th:text="${totalRegistros}">0</h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card text-white bg-success">
                        <div class="card-body text-center">
                            <h5 class="card-title">Clasificaciones</h5>
                            <h2 th:text="${distribucionClasificacion.size()}">0</h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card text-white bg-info">
                        <div class="card-body text-center">
                            <h5 class="card-title">Usuarios Analizados</h5>
                            <h2 th:text="${totalRegistros}">0</h2>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Distribuci√≥n por clasificaci√≥n -->
            <div class="row mb-4" th:if="${not distribucionClasificacion.empty}">
                <div class="col-md-6">
                    <div class="card h-100">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">üìà Distribuci√≥n por Clasificaci√≥n</h5>
                        </div>
                        <div class="card-body">
                            <canvas id="clasificacionChart" width="400" height="300"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card h-100">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0">üìã Detalles por Clasificaci√≥n</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>Clasificaci√≥n</th>
                                            <th>Cantidad</th>
                                            <th>Porcentaje</th>
                                            <th>Promedio Huella</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr th:each="entry : ${distribucionClasificacion}">
                                            <td th:text="${entry.key}">Clasificaci√≥n</td>
                                            <td th:text="${entry.value}">0</td>
                                            <td th:text="${porcentajeClasificacion.get(entry.key)} + '%'">0%</td>
                                            <td th:text="${(promedioHuella.get(entry.key) != null) ? promedioHuella.get(entry.key) + ' kg CO‚ÇÇ' : 'N/A'}">0 kg CO‚ÇÇ</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Distribuci√≥n por g√©nero y Top 5 -->
            <div class="row mb-4">
                <div class="col-md-6" th:if="${not generoStats.empty}">
                    <div class="card h-100">
                        <div class="card-header bg-warning text-dark">
                            <h5 class="mb-0">üë• Distribuci√≥n por G√©nero</h5>
                        </div>
                        <div class="card-body">
                            <canvas id="generoChart" width="400" height="300"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-6" th:if="${not topMayoresHuellas.empty}">
                    <div class="card h-100">
                        <div class="card-header bg-danger text-white">
                            <h5 class="mb-0">üî• Top 5 Mayores Huellas</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>#</th>
                                            <th>Huella (kg CO‚ÇÇ)</th>
                                            <th>Clasificaci√≥n</th>
                                            <th>G√©nero</th>
                                            <th>Edad</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr th:each="calc, stat : ${topMayoresHuellas}">
                                            <td th:text="${stat.count}">1</td>
                                            <td th:text="${#numbers.formatDecimal(calc.resultado, 1, 2)}">0.00</td>
                                            <td>
                                                <span th:text="${calc.clasificacion}" 
                                                      th:class="${calc.clasificacion == 'Muy Alta (Impacto significativo)'} ? 'badge bg-danger' : 
                                                                 (${calc.clasificacion == 'Alta (Necesita mejorar)'} ? 'badge bg-warning text-dark' : 
                                                                 (${calc.clasificacion == 'Media (Promedio)'} ? 'badge bg-info' : 'badge bg-success'))">
                                                    Clasificaci√≥n
                                                </span>
                                            </td>
                                            <td>
                                                <span th:switch="${calc.sexo}">
                                                    <span th:case="'M'">üë® Masculino</span>
                                                    <span th:case="'F'">üë© Femenino</span>
                                                    <span th:case="'O'">‚öß Otro</span>
                                                    <span th:case="'P'">‚ùì Prefiero no decir</span>
                                                </span>
                                            </td>
                                            <td th:text="${calc.edad}">0</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Scripts para gr√°ficos CORREGIDOS -->
            <!-- Scripts para gr√°ficos - VERSI√ìN FUNCIONAL -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Iniciando gr√°ficos...');
        
        // Gr√°fico de clasificaci√≥n - DATOS DIRECTOS
        const clasificacionCtx = document.getElementById('clasificacionChart');
        if (clasificacionCtx) {
            console.log('Creando gr√°fico de clasificaci√≥n...');
            new Chart(clasificacionCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Baja (Ecol√≥gica)', 'Media (Promedio)', 'Alta (Necesita mejorar)', 'Muy Alta (Impacto significativo)'],
                    datasets: [{
                        data: [3, 1, 1, 3], // Tus datos de la consola
                        backgroundColor: ['#28a745', '#17a2b8', '#ffc107', '#dc3545'],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
            console.log('Gr√°fico de clasificaci√≥n creado');
        } else {
            console.log('No se encontr√≥ clasificacionChart');
        }
        
        // Gr√°fico de g√©nero - DATOS DIRECTOS
        const generoCtx = document.getElementById('generoChart');
        if (generoCtx) {
            console.log('Creando gr√°fico de g√©nero...');
            new Chart(generoCtx, {
                type: 'bar',
                data: {
                    labels: ['Masculino', 'Femenino'],
                    datasets: [{
                        label: 'Cantidad de Usuarios',
                        data: [6, 2], // Tus datos de la consola
                        backgroundColor: ['#007bff', '#e83e8c'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
            console.log('Gr√°fico de g√©nero creado');
        } else {
            console.log('No se encontr√≥ generoChart');
        }
    });
</script>
        </div>
    </div>
</body>
</html>